{% extends "dashboard/index.html" %}
{% block titulo %} Horarios por docente {% endblock %}
{% block contenido %}
<script src="{{ url_for('static', filename='login/libs/sweetalert2/sweetalert2.js') }}"></script>
<style>
    /*INICIO ESTILOS DEL BUSCADOR*/
    #buscador-multiopcion-sugerencias{
        position: relative;
        margin: 0;
        padding: 0;
        /*background-color: black;*/
    }

    #buscador-multiopcion-sugerencias #bmos-barra-busqueda {
        width: 100%;
        /* background-color: red; */
        height: 100%;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        padding-inline: 10px;
        border: 1px #DEE2E6 solid;
        border-radius: 4px;
        outline: none;
        overflow-y: hidden;
        cursor: text;

        &:active{
            border: 1px #9DBEEE solid;
            outline: 4px #CEDEF6 solid;
        }
    }

    #buscador-multiopcion-sugerencias #bmos-barra-busqueda p {
        order: 2;
        pointer-events: fill;
        width: 100%;
        margin: 5px 0;
        white-space: nowrap;
        overflow-x: hidden;
        flex: 1 0 min(100%, 20%);

        &:focus-within {
            outline: none;
        }
    }

    #buscador-multiopcion-sugerencias #bmos-barra-busqueda .bmos-etiqueta {
        background-color: rgb(217, 217, 217);
        padding: 6px;
        border-radius: 8px;
        margin: 3px;
        order: 1;
        flex: 0 1 auto;

        &:hover {
            background-color: rgb(185, 185, 185);
        }

        button {
            font-size: 20px;
            border: none;
            margin-left: 5px;
            margin-right: 0px;
            background-color: transparent;
            color: rgb(62, 62, 62);
        }
    }

    #buscador-multiopcion-sugerencias.active #bmos-lista-sugerencias {
        display: block;
    }

    #buscador-multiopcion-sugerencias #bmos-lista-sugerencias {
        background-color: rgb(217, 217, 217);
        list-style: none;
        margin-top: 8px;
        border-radius: 10px;
        padding: 0px;
        overflow-y: hidden;
        display: none;
        position: absolute;
    }

    #buscador-multiopcion-sugerencias #bmos-lista-sugerencias .bmos-sugerencia {
        padding: 11px;
        padding-left: 10px;

        &:hover {
            background-color: rgb(185, 185, 185);
        }
    }
    /*FIN ESTILOS DEL BUSCADOR*/

    /*INICIO ESTILOS HORARIO*/
    #espacio_tabla table{
        border: 1px solid grey;
        border-collapse: collapse;
        width: 100%;

        :is(th,td){
            border: 1px solid grey;
            width: 500px;
        }

        & td{
            max-height: 20px;
        }

        & th{
            padding: 0.5rem 0;
        }

        :is(th, td:first-child){
            background-color: rgb(228, 228, 228);
            text-align: center;
            font-weight: bold;
            color: rgb(0, 0, 226);
        }

        & td:nth-child(n+2):not(:empty){
            background-color: #efd915;
            color: black;
            text-align: center;
            padding: 0.8rem 3px 1.5rem 3px;

            & span{
                width: 100%;
                display: block;
                margin: 3px 0;
            }

            :nth-child(4){
                color: white;
                font-weight: bold;
                padding: 1px 0;
                margin: 0.8rem 0 1.5rem 0;
            }

            :nth-child(4)[data-tipo="Presencial"] {
                background-color: #4214fa;
            }

            :nth-child(4)[data-tipo="Virtual"] {
                background-color: red;
            }

            :nth-child(5){
                color: #4214fa;
                font-weight: bold;
            }
        }
    }
    /*FIN ESTILOS HORARIO*/
    .texto-label{
        color: #70767F;
        text-transform: uppercase;
        font-weight: bold;
    }

    .texto-input{
        color: black;
    }

    .foot{
        background-color: black;
        border-color: black;
    }

    .foot:hover{
        background-color: black;
        border-color: black;
    }

    .foot:active{
        background-color: black;
        border-color: black;
    }

    @media (max-width: 570px) {
    #foto_perfil {
        display: none;
    }
    }

    #foto_perfil{
        max-height: 100px;
    }
</style>

<nav style="--bs-breadcrumb-divider: '>'" aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item" href="Home"><a>Inicio</a></li>
        <li class="breadcrumb-item active" data-href="#"><a>Horarios por docente</a></li>

    </ol>
</nav>


<div class="card mx-2" id="card_horarios">
    <div class="card-header bg-red-usat text-white" id="headingOne" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
        Horarios asignados por docente
    </div>
    <div id="collapseOne" class="collapse" aria-labelledby="headingOne" data-bs-parent="#miAccordion">
        <div class="card-body">
            <div class="container">
                <!-- Div superior -->
                <div class="row row align-items-end my-3">
                    <div class="col-md-10 order-md-1 order-sm-2">
                        <!-- Primer input y label -->
                        <div class="form-group row mb-3 d-flex justify-content-center">
                            <label for="combo_semestre" class="col-form-label col-12 col-sm-12 col-md-4 col-lg-3 col-xl-3 texto-label">Semestre académico:</label>
                            <div class="col-12 col-sm-12 col-md-8 col-lg-9 col-xl-9">
                                <select class="form-select" aria-label="Default select example" id="combo_semestre">
                                    <option selected>[-- SELECCIONE --]</option>
                                    {% for semestre in semestres %}
                                        <option value="{{semestre[1]}}">{{semestre[1]}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <!-- Segundo input y label -->
                        <div class="form-group row d-flex justify-content-center" style="align-items: center;">
                            <label for="search_bar" class="col-form-label col-12 col-sm-12 col-md-4 col-lg-3 col-xl-3 texto-label">Docente:</label>
                            <div class="col-12 col-sm-12 col-md-8 col-lg-9 col-xl-9">
                                <!-- Buscador con autocompletado de sugerencias -->
                                <div id="buscador-multiopcion-sugerencias" class="">
                                    <div id="bmos-barra-busqueda" contenteditable="false">
                                        <p contenteditable="true"></p>
                                    </div>
                                    <ul id="bmos-lista-sugerencias">
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2 order-md-2 order-sm-1  d-flex justify-content-center align-items-center">
                        <!-- Foto -->
                        <img src="/static/img/USUARIO.jpg" class="img-fluid" alt="Foto" id="foto_perfil">
                    </div>
                </div>
                <!-- Tabla inferior -->
                <div class="card-body show">
                    <div class="row mt-3">
                        <div class="col-md-12" id="espacio_tabla">
                        </div>
                    </div>
                </div>
            </div>

        </div>

    </div>
    <table id="horario-table">
        <thead id="encabezado">
    
        </thead>
        <tbody id="cuerpo">
    
        </tbody>
    
    </table>
    <div href="#" id="" data-href="" class="btn btn-success foot" style="height: 20px;"></div>
</div>


<script>
    const espacio_tabla = document.querySelector("#espacio_tabla");
    const columna_horas=[];
    for (let i = 7; i < 23; i++) {
            columna_horas.push(`${i.toString().padStart(2, '0')}:00 - ${(i+1).toString().padStart(2, '0')}:00`);
        }

    const columna_dias=['Lunes','Martes','Miércoles','Jueves','Viernes','Sábado','Domingo'];
    let bmos_lista_datos = [];

        function mostrarAlerta(icon, title, text) {
            Swal.fire({
                icon: icon,
                title: title,
                text: text
            });
        }

        function mostrarFoto(nombre_foto) {
            nombre_foto = nombre_foto.toUpperCase().replace(/ /g, "_");
            nombre_formateado = nombre_foto.normalize("NFD").replace(/[\u0300-\u036f]/g, "");

            var img = new Image();
            img.src = "/static/img/" + nombre_formateado + ".jpg";

            img.onload = function() {
                document.getElementById("foto_perfil").src = img.src;
            };
            
            img.onerror = function() {
                document.getElementById("foto_perfil").src = "/static/img/USUARIO.jpg";
            };
        }

        function obtener_docentes() {
            fetch('/get_personas_docentes_activas', {
            headers: {
                'Content-Type': 'application/json'
            },
            })
            .then(response => response.json())
            .then(data => {
                bmos_lista_datos = data;
                
            })
            .catch(error => {
                mostrarAlerta("error", "No se pudo obtener los horarios", error.responseText);
            });
        } 

    $(document).ready(function(){
        obtener_docentes();
        $('#collapseOne').collapse('show');
    });
    
    

    /*INICIO SCRIPT BUSCADOR*/

    const bmos_contenedor = document.querySelector("#buscador-multiopcion-sugerencias");
    const bmos_barra_busqueda = document.querySelector("#bmos-barra-busqueda");
    const bmos_etiquetas_busqueda = bmos_barra_busqueda.querySelectorAll(".bmos-etiqueta");
    const bmos_input = bmos_barra_busqueda.querySelector("p");
    const bmos_lista_sugerencias = document.querySelector("#bmos-lista-sugerencias");
    

    bmos_input.onkeyup = (event) => {
        let datos_entrada = bmos_input.textContent;
        let datos_salida = [];

        if(datos_entrada.length){
            bmos_contenedor.classList.add("active");
            datos_salida = bmos_generar_sugerencias(datos_entrada);
            datos_filtrados = bmos_filtrar_sugerencias(datos_salida);
            bmos_mostrar_sugerencias(datos_filtrados);

        }else{
            bmos_contenedor.classList.remove("active");
        }
    };

    function bmos_generar_sugerencias(dato) {
    let datos_salida = [];
    bmos_lista_datos.forEach(element => {
        var nombre = element[2] + " " + element[1];
        var id = element[0];

        if (nombre.toLowerCase().trim().includes(dato.toLowerCase().trim())) {
            datos_salida.push([id, nombre]);
        }
    });
    return datos_salida;
}


    function bmos_mostrar_sugerencias(lista){
        bmos_lista_sugerencias.innerHTML = "";
        lista.forEach(element => {
            bmos_lista_sugerencias.innerHTML += 
            `<li class="bmos-sugerencia" onclick="bmos_insertar_etiqueta(this);"
             id="${element[0]}">${element[1]}</li>`;
        });
    }

    function bmos_insertar_etiqueta(element){
        if(element.id != -1){
            bmos_input.textContent = "";
            bmos_contenedor.classList.remove("active");
            var nuevoSpan = document.createElement("span");
            nuevoSpan.className = "bmos-etiqueta";
            nuevoSpan.setAttribute("contenteditable", "false");
            nuevoSpan.setAttribute("id",`${element.id}`);
            nuevoSpan.innerHTML = `${element.textContent}<button onclick="bmos_eliminarEtiqueta(this);">X</button>`;       
            bmos_barra_busqueda.appendChild(nuevoSpan);
            bmos_input.focus();
        }
    }

    function bmos_eliminarEtiqueta(element){
        element.parentNode.remove();
    }
    
    function bmos_filtrar_sugerencias(lista_sugerencias){
        if(lista_sugerencias.length){
            let lista_sugerencias_2 = lista_sugerencias.map(function(elements){
                return elements[1];
            });
            bmos_barra_busqueda.querySelectorAll('.bmos-etiqueta').forEach(etiqueta =>{
                var sugerencia = (etiqueta.textContent).slice(0,-1);

                indice = lista_sugerencias_2.indexOf(sugerencia);
                if(indice!=-1){
                    lista_sugerencias.splice(indice,1);
                }
            });
        }else{
            lista_sugerencias.push([-1,"No hay resultados"]);
        }
        return lista_sugerencias;
    }

    bmos_barra_busqueda.addEventListener("click",()=>{
        bmos_input.focus();
    });


    bmos_barra_busqueda.addEventListener("keydown",function(event){
        if(event.key === "Enter"){
            event.preventDefault();
        }
    });

    document.addEventListener("click", (event) => {
        const buscadorMultiopcion = document.querySelector("#buscador-multiopcion-sugerencias");
        if (!buscadorMultiopcion.contains(event.target)) {
            buscadorMultiopcion.classList.remove("active");
        }
    });
    /*FIN SCRIPT BUSCADOR*/

    /*INICIO SCRIPT MOSTRAR TABLAS*/

    function obtenerHorariosDocente(id_docente,semestre){
        return fetch('/get_horarios_docentesId_semestre', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                id_docente: id_docente,
                semestre: semestre
            })
            })
            .then(response => response.json())

            .catch(error => {
                console.error('Error al obtener horarios:', error);
            });
    }

    // let horarios = obtenerHorariosDocente(element.id, '2024-I')
    //             .then(horarios => {
    //                 mostrarHorarios(horarios);
    //             })
    //             .catch(error => {
    //                 console.error('Error al obtener horarios:', error);
    //             });
    //         }
    let horarios_prueba = [[1,'Aula 101','CALIDAD Y DESARROLLO DE SOFTWARE','LUNES','07:00:00','09:00:00',2,3,'Presencial','A',7,'SIS']
                            ,[2,'Aula 305','DISEÑO DE SOFTWARE','LUNES','13:00:00','15:00:00',3,3,'Virtual','B',5,'SIS']
                            ,[3,'Aula 200','INVESTIGACIÓN DE INGENIERÍA','MIERCOLES','18:00:00','20:00:00',4,1,'Virtual','C',7,'SIS']
                            ,[4,'Laboratorio 119','SISTEMAS DISTRIBUIDOS','MARTES','08:00:00','11:00:00',4,1,'Presencial','A',6,'SIS']
                            ,[5,'Laboratorio 119','SISTEMAS DISTRIBUIDOS','VIERNES','10:00:00','12:00:00',4,1,'Presencial','A',6,'SIS']];

    function crearTablaHorario(id_docente,horarios_docente){
        espacio_tabla.innerHTML += `<table id="horario_${id_docente}"><thead><tr><th colspan="8">DOCENTE</th></tr>
            <tr><th>Horas</th></tr></thead><tbody></tbody></table>`;
        var thead_tabla = document.querySelector(`#horario_${id_docente} thead tr:nth-child(2)`);
        var tbody_tabla = document.querySelector(`#horario_${id_docente} tbody`);
        thead_tabla.innerHTML += columna_dias.map(dia => `<th>${dia}</th>`).join('');

        if(!horarios_docente.length){
            tbody_tabla.innerHTML +=`<tr><td colspan="8">No hay horarios registrados</td></tr>`;
        }else{
            for(let i=0; i<columna_horas.length; i++){
                var fila = `<tr><td>${columna_horas[i]}</td>`;
                var h_inicio_tabla = parseInt(columna_horas[i].substring(0,2));
                var h_fin_tabla = h_inicio_tabla+1;
                for(let j=0; j<columna_dias.length; j++){
                    fila += "<td>";
                    var dia_tabla = columna_dias[j].normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim().toUpperCase();
                    for(let k=0; k<horarios_docente.length; k++){
                        var dia_horario = horarios_docente[k][3].normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim().toUpperCase();
                        var h_inicio_horario = parseInt(horarios_docente[k][4].substring(0,2)); 
                        var h_fin_horario = parseInt(horarios_docente[k][5].substring(0,2));
                        if (dia_horario===dia_tabla && h_inicio_tabla>=h_inicio_horario && h_fin_tabla<=h_fin_horario){
                            var curso = horarios_docente[k][2];
                            var ciclo = horarios_docente[k][10];
                            var carrera = horarios_docente[k][11];
                            var grupo = horarios_docente[k][9];
                            var tipo = horarios_docente[k][8];
                            var ambiente = horarios_docente[k][1];
                            fila+= `<span>${curso}</span>`;
                            fila+= `<span>(${ciclo} ciclo - Grupo ${grupo})</span>`;
                            fila+= `<span>${carrera}</span>`;
                            fila+=`<span data-tipo="${tipo}">${tipo}</span>`;
                            fila+=`<span>${ambiente}</span>`;
                        }   
                    }
                    fila+="</td>";
                }
                tbody_tabla.innerHTML+= fila;
            }
        }
    }
    crearTablaHorario(1,horarios_prueba);

    /*FIN SCRIPT MOSTRAR TABLAS*/
</script>

{% endblock %}