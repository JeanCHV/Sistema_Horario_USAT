{% extends "dashboard/index.html" %}
{% block titulo %} Horarios por docente {% endblock %}
{% block contenido %}
<script src="{{ url_for('static', filename='login/libs/sweetalert2/sweetalert2.js') }}"></script>
<style>
    .texto-label{
        color: #70767F;
        text-transform: uppercase;
        font-weight: bold;
    }

    .texto-input{
        color: black;
    }

    .foot{
        background-color: black;
        border-color: black;
    }

    .foot:hover{
        background-color: black;
        border-color: black;
    }

    .foot:active{
        background-color: black;
        border-color: black;
    }

    @media (max-width: 570px) {
    #foto_perfil {
        display: none;
    }
    }

    #foto_perfil{
        max-height: 100px;
    }

</style>

<nav style="--bs-breadcrumb-divider: '>'" aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item" href="Home"><a>Inicio</a></li>
        <li class="breadcrumb-item active" data-href="#"><a>Horarios por docente</a></li>

    </ol>
</nav>


<div class="card mx-2" id="card_horarios">
    <div class="card-header bg-red-usat text-white" id="headingOne" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
        Horarios asignados por docente
    </div>
    <div id="collapseOne" class="collapse" aria-labelledby="headingOne" data-bs-parent="#miAccordion">
        <div class="card-body">
            <div class="container">
                <!-- Div superior -->
                <div class="row row align-items-end my-3">
                    <div class="col-md-10 order-md-1 order-sm-2">
                        <!-- Primer input y label -->
                        <div class="form-group row mb-3 d-flex justify-content-center">
                            <label for="combo_semestre" class="col-form-label col-12 col-sm-12 col-md-4 col-lg-3 col-xl-3 texto-label">Semestre académico:</label>
                            <div class="col-12 col-sm-12 col-md-8 col-lg-9 col-xl-9">
                                <select class="form-select" aria-label="Default select example" id="combo_semestre">
                                    <option selected>[-- SELECCIONE --]</option>
                                    {% for semestre in semestres %}
                                        <option value="{{semestre[1]}}">{{semestre[1]}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <!-- Segundo input y label -->
                        <div class="form-group row d-flex justify-content-center" style="align-items: center;">
                            <label for="search_bar" class="col-form-label col-12 col-sm-12 col-md-4 col-lg-3 col-xl-3 texto-label">Docente:</label>
                            <div class="col-12 col-sm-12 col-md-8 col-lg-9 col-xl-9">
                                <!-- Buscador con autocompletado de sugerencias -->
                                <div id="search_bar"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2 order-md-2 order-sm-1  d-flex justify-content-center align-items-center">
                        <!-- Foto -->
                        <img src="/static/img/USUARIO.jpg" class="img-fluid" alt="Foto" id="foto_perfil">
                    </div>
                </div>
                <!-- Tabla inferior -->
                <div class="card-body show">
                    <div class="row mt-3">
                        <div class="col-md-12" id="espacio_tabla">
                            <table class="table table-bordered text-center" id="tabla_inicial">
                                <thead class="border border-warning bg-red-usat">
                                  <tr>
                                    <th scope="col" class="border border-white text-light">Hora</th>
                                    <th scope="col" class="border border-white text-light">Lunes</th>
                                    <th scope="col" class="border border-white text-light">Martes</th>
                                    <th scope="col" class="border border-white text-light">Miércoles</th>
                                    <th scope="col" class="border border-white text-light">Jueves</th>
                                    <th scope="col" class="border border-white text-light">Viernes</th>
                                    <th scope="col" class="border border-white text-light">Sábado</th>
                                    <th scope="col" class="border border-white text-light">Domingo</th>
                                  </tr>
                                </thead>
                                <tbody class="" style="background-color: #EEEEEE;">
                                    <tr>
                                        <th scope="row">X</th>
                                        <th scope="row">X</th>
                                        <th scope="row">X</th>
                                        <th scope="row">X</th>
                                        <th scope="row">X</th>
                                        <th scope="row">X</th>
                                        <th scope="row">X</th>
                                        <th scope="row">X</th>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
    <div href="#" id="" data-href="" class="btn btn-success foot" style="height: 20px;"></div>
</div>


<script>
        function mostrarAlerta(icon, title, text) {
            Swal.fire({
                icon: icon,
                title: title,
                text: text
            });
        }

        function mostrarFoto(nombre_foto) {
            nombre_foto = nombre_foto.toUpperCase().replace(/ /g, "_");
            nombre_formateado = nombre_foto.normalize("NFD").replace(/[\u0300-\u036f]/g, "");

            var img = new Image();
            img.src = "/static/img/" + nombre_formateado + ".jpg";

            img.onload = function() {
                document.getElementById("foto_perfil").src = img.src;
            };
            
            img.onerror = function() {
                document.getElementById("foto_perfil").src = "/static/img/USUARIO.jpg";
            };
        }


    $(document).ready(function(){
        let listaDocentes = [];

        function obtenerDatosDocentes() {
            fetch('/get_personas_activas')
                .then(response => response.json())
                .then(data => {
                    data.forEach(element => {
                        listaDocentes.push(element[2] + ' ' + element[1])
                    });
                    var widget = new AutoComplete('search_bar', listaDocentes);
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }
        obtenerDatosDocentes();
        var inputEl = document.getElementById('tuInputId'); // Obtén el elemento input por su ID

        $('#collapseOne').collapse('show');
    });
    




    function obtenerHorarios(lista_nombres_docentes,semestre) {
        lista_nombres_docentes.forEach(nombre_docente => {
            fetch('/get_horarios_docentesNombres_semestre', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                nombre_docente : nombre_docente,
                semestre : semestre,
            })
            })
            .then(response => response.json())
            .then(data => {
                mostrarHorariosEnTabla(nombre_docente,data);
            })
            .catch(error => {
            console.error('Error:', error);
            }); 
        });
        }

        function mostrarHorariosEnTabla(nomb_docente,data){
            nombreX_docente = nomb_docente.toUpperCase().replace(/ /g, "_");
            nombre_docente = nombreX_docente.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            if(!document.querySelector(`#fila-propietario-tabla-${nombre_docente}`)){
                const dias_semana = ['Lunes','Martes','Miércoles','Jueves','Viernes','Sábado','Domingo'];
                const lista_horarios = [
                '7:00 a.m. - 8:00 a.m.',
                '8:00 a.m. - 9:00 a.m.',
                '9:00 a.m. - 10:00 a.m.',
                '10:00 a.m. - 11:00 a.m.',
                '11:00 a.m. - 12:00 p.m.',
                '12:00 p.m. - 13:00 p.m.',
                '13:00 p.m. - 14:00 p.m.',
                '14:00 p.m. - 15:00 p.m.',
                '15:00 p.m. - 16:00 p.m.',
                '16:00 p.m. - 17:00 p.m.',
                '17:00 p.m. - 18:00 p.m.',
                '18:00 p.m. - 19:00 p.m.',
                '19:00 p.m. - 20:00 p.m.',
                '20:00 p.m. - 21:00 p.m.',
                '21:00 p.m. - 22:00 p.m.'
                ];
                
                document.getElementById("espacio_tabla").innerHTML+=
                `
                    <table class="table table-bordered text-center" id="fila-propietario-tabla-${nombre_docente}">
                        <div class="border border-warning bg-blue-horario-usat" 
                        style="display: flex;align-items:center;justify-content: center;color: white;font-weight: bold;height: 45px;">
                            ${nomb_docente}
                        </div>
                        <thead class="border border-warning bg-blue-horario-usat">
                            <tr class="fila-dias-tabla-${nombre_docente}">
                            </tr>
                        </thead>
                        <tbody class="" style="background-color: #EEEEEE;">
                            <tr class="fila-horas-tabla-${nombre_docente}">
                            </tr>
                        </tbody>
                    </table>
                `;
                for (let i = 0; i < dias_semana.length; i++) {
                    if(i==0){
                        document.querySelector(`.fila-dias-tabla-${nombre_docente}`).innerHTML+=
                        `
                            <th scope="col" class="border border-warning text-light">Hora</th>
                            <th scope="col" class="border border-warning text-light">${dias_semana[i]}</th>
                        `;
                    }else{
                        document.querySelector(`.fila-dias-tabla-${nombre_docente}`).innerHTML+=
                        `
                            <th scope="col" class="border border-warning text-light">${dias_semana[i]}</th>
                        `;
                    }     
                }

                for (let i = 0; i < dias_semana.length+1; i++) {
                    document.querySelector(`.fila-horas-tabla-${nombre_docente}`).innerHTML+=
                    `
                        <th scope="row">X</th>
                    `;
                }
            }
        }

    var docentes_seleccionados = []
    // Función para configurar el observador de mutaciones
    function setupMutationObserver() {
    // Seleccionar el elemento con la clase "tokens-6a7a0"
    var tokensContainer = document.querySelector('.tokens-6a7a0');
    // Verificar si el elemento está presente en el documento
    if (tokensContainer) {
        // Crear un observer para observar cambios en el contenido del elemento
        var observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            // Verificar si se insertó un nodo
            if (mutation.type === 'childList') {
            // Recorrer los nodos insertados
            mutation.addedNodes.forEach(function(node) {
                // Verificar si el nodo insertado tiene la clase "token-group-c7334"
                if (node.classList && node.classList.contains('token-group-c7334')) {
                // Encontrar el span con la clase "token-75233" dentro del nodo insertado
                var tokenSpan = node.querySelector('.token-75233');
                    // Ejecutar acciones al encontrar el span
                    if (tokenSpan){                       
                        docentes_seleccionados.push(tokenSpan.textContent);
                    }
                }
                
            });
            // Verificar si se eliminó un nodo
            mutation.removedNodes.forEach(function(node) {
            // Verificar si el nodo eliminado tenía la clase "token-group-c7334"
                if (node.classList && node.classList.contains('token-group-c7334')) {
                    // Aquí puedes ejecutar acciones cuando se elimina un elemento con la clase "token-group-c7334"                   
                    var tokenSpan = node.querySelector('.token-75233');
                    if (tokenSpan) {                        
                        // Eliminar el texto del span de la lista
                        var index = docentes_seleccionados.indexOf(tokenSpan.textContent);
                        if (index !== -1) {
                        docentes_seleccionados.splice(index, 1);
                        }                      
                    }
                }
            });

            }
        });
        semestre = document.getElementById('combo_semestre').value;
        docentes_seleccionados_sin_repeticiones = docentes_seleccionados.filter((elemento,index)=>{
            return docentes_seleccionados.indexOf(elemento) === index;
        });
        if(semestre!='[-- SELECCIONE --]'){
            if(docentes_seleccionados_sin_repeticiones.length==0){
                document.getElementById("tabla_inicial").style.visibility = "visible";
                
            }else if(docentes_seleccionados_sin_repeticiones.length>1){
                obtenerHorarios(docentes_seleccionados_sin_repeticiones,semestre);
                document.getElementById("tabla_inicial").style.visibility ="collapse";

            }else if (docentes_seleccionados_sin_repeticiones.length==1) {
                obtenerHorarios(docentes_seleccionados_sin_repeticiones,semestre);
                document.getElementById("tabla_inicial").style.visibility ="collapse";  

            }
        }

        if(docentes_seleccionados_sin_repeticiones.length>1){
        mostrarFoto("USUARIOS");

        }else if (docentes_seleccionados_sin_repeticiones.length==1) {
            mostrarFoto(docentes_seleccionados[0]);

        } else {
            mostrarFoto("USUARIO");
        }
        });
    
        // Configurar las opciones del observer para observar cambios en el contenido y la estructura del elemento
        var observerConfig = { childList: true, subtree: true };
    
        // Comenzar a observar el elemento
        observer.observe(tokensContainer, observerConfig);
    } else {
        // El elemento aún no está presente, esperar y volver a intentarlo
        setTimeout(setupMutationObserver, 500); // Intentar nuevamente después de 500 milisegundos

        
    }
    }

    // Llamar a la función de configuración del observador de mutaciones
    setupMutationObserver();

    document.getElementById("combo_semestre").addEventListener("change", function() {
        var semestre = this.value;
        obtenerHorarios(docentes_seleccionados_sin_repeticiones,semestre);
    });


</script>

{% endblock %}