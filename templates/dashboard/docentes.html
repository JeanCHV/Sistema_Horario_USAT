{% extends "dashboard/index.html" %}
{% block titulo %} Docentes {% endblock %}
{% block contenido %}
<nav style="--bs-breadcrumb-divider: '>'" aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Inicio</a></li>
        <li class="breadcrumb-item active"><a href="{{ url_for('docentes') }}">Docentes</a></li>
    </ol>
</nav>

<div class="container-fluid my-4">
    <div class="card w-100" id="card_docentes">
        <div class="card-header bg-red-usat text-white" id="headingOne" data-bs-toggle="collapse"
            data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
            Docentes
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table id="tabla-docente" class="table table-striped tabla-docentes tabla-comun" style="width:100%">
                    <thead>
                        <tr>
                            <th style="text-align:center">Nombres</th>
                            <th style="text-align:center">Correo</th>
                            <th style="text-align:center">Teléfono</th>
                            <th style="text-align:center">Opciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Los datos de los docentes se cargarán dinámicamente aquí -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- MODAL AGREGAR DOCENTE -->
    <div class="modal fade" id="modalAgregarDocente" tabindex="-1" aria-labelledby="modalDocenteLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Agregar Docente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="formAgregarDocente">
                        <div class="mb-3">
                            <label for="nombreDocente" class="form-label">Nombres:</label>
                            <input type="text" class="form-control" id="nombreDocente" name="nombres" required>
                        </div>
                        <div class="mb-3">
                            <label for="apellidosDocente" class="form-label">Apellidos:</label>
                            <input type="text" class="form-control" id="apellidosDocente" name="apellidos" required>
                        </div>
                        <div class="mb-3">
                            <label for="documentoDocente" class="form-label">Número de Documento:</label>
                            <input type="text" class="form-control" id="documentoDocente" name="n_documento"
                                maxlength="8" pattern="\d{8}" oninput="validarNumeroDocumento(this)" required>
                            <div class="invalid-feedback">
                                El número de documento debe tener exactamente 8 dígitos.
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="telefonoDocente" class="form-label">Teléfono:</label>
                            <input type="text" class="form-control" id="telefonoDocente" name="telefono" maxlength="9"
                                pattern="\d{9}" oninput="validarTelefono(this)" required>
                            <div class="invalid-feedback">
                                El número de teléfono debe tener exactamente 9 dígitos.
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="correoDocente" class="form-label">Correo:</label>
                            <input type="email" class="form-control" id="correoDocente" name="correo"
                                oninput="completarCorreo(this)" required>
                        </div>
                        <div class="mb-3">
                            <label for="cantHorasDocente" class="form-label">Cantidad de Horas:</label>
                            <input type="number" class="form-control" id="cantHorasDocente" name="cantHoras" required>
                        </div>
                        <div class="mb-3">
                            <label for="tiempoRefDocente" class="form-label">Tiempo de Referencia:</label>
                            <input type="number" class="form-control" id="tiempoRefDocente" name="tiempo_ref" required>
                        </div>
                        <div class="mb-3">
                            <label for="estadoDocente" class="form-label">Estado:</label>
                            <select class="form-control" id="estadoDocente" name="estado" required>
                                <option value="1">Activo</option>
                                <option value="0">Inactivo</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Guardar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL MODIFICAR DOCENTE -->
    <div class="modal fade" id="modalModificarDocente" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Modificar Docente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formModificarDocente">
                        <div class="mb-3">
                            <label for="modificarNombreDocente" class="form-label">Nombres:</label>
                            <input type="text" class="form-control" id="modificarNombreDocente" name="nombres" required>
                        </div>
                        <div class="mb-3">
                            <label for="modificarApellidosDocente" class="form-label">Apellidos:</label>
                            <input type="text" class="form-control" id="modificarApellidosDocente" name="apellidos"
                                required>
                        </div>
                        <div class="mb-3">
                            <label for="modificarDocumentoDocente" class="form-label">Número de Documento:</label>
                            <input type="text" class="form-control" id="modificarDocumentoDocente" name="n_documento"
                                maxlength="8" pattern="\d{8}" oninput="validarNumeroDocumento(this)" required>
                            <div class="invalid-feedback">
                                El número de documento debe tener exactamente 8 dígitos.
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="modificarTelefonoDocente" class="form-label">Teléfono:</label>
                            <input type="text" class="form-control" id="modificarTelefonoDocente" name="telefono"
                                maxlength="9" pattern="\d{9}" oninput="validarTelefono(this)" required>
                            <div class="invalid-feedback">
                                El número de teléfono debe tener exactamente 9 dígitos.
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="modificarCorreoDocente" class="form-label">Correo:</label>
                            <input type="email" class="form-control" id="modificarCorreoDocente" name="correo"
                                oninput="completarCorreo(this)" required>
                        </div>
                        <div class="mb-3">
                            <label for="modificarCantHoras" class="form-label">Cantidad de Horas:</label>
                            <input type="number" class="form-control" id="modificarCantHoras" name="cantHoras" required>
                        </div>
                        <div class="mb-3">
                            <label for="modificarTiempoRef" class="form-label">Tiempo de Refrigerio:</label>
                            <input type="number" class="form-control" id="modificarTiempoRef" name="tiempo_ref"
                                required>
                        </div>
                        <div class="mb-3">
                            <label for="modificarEstadoDocente" class="form-label">Estado:</label>
                            <select class="form-control" id="modificarEstadoDocente" name="estado" required>
                                <option value="1">Activo</option>
                                <option value="0">Inactivo</option>
                            </select>
                        </div>
                        <input type="hidden" id="modificarIdDocente" name="idpersona">
                        <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para la subida masiva de datos -->
<div class="modal fade" id="modalSubidaMasiva" tabindex="-1" aria-labelledby="modalSubidaMasivaLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalSubidaMasivaLabel">Subida Masiva de Datos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formSubidaMasiva" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="archivo" class="form-label">Seleccionar archivo (Excel):</label>
                        <input type="file" class="form-control" id="archivo" name="archivo" accept=".xls,.xlsx"
                            required>
                    </div>
                    <div class="progress mb-3" style="height: 25px;">
                        <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%;"
                            aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                    </div>
                    <button type="submit" class="btn btn-primary">Subir</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>

    function completarCorreo(input) {
        const value = input.value;
        const lastChar = value.charAt(value.length - 1);
        const parts = value.split('@');

        if (parts.length > 1) {
            const username = parts[0];
            const domain = parts[1];

            switch (domain) {
                case 'u':
                    input.value = username + '@usat.edu.pe';
                    break;
                case 'g':
                    input.value = username + '@gmail.com';
                    break;
                case 'o':
                    input.value = username + '@outlook.com';
                    break;
                case 'h':
                    input.value = username + '@hotmail.com';
                    break;
            }
        }
    }
    function validarNumeroDocumento(input) {
        const regex = /^\d{0,8}$/;
        if (!regex.test(input.value)) {
            input.value = input.value.slice(0, -1);
        }
        if (input.value.length === 8) {
            input.setCustomValidity('');
        } else {
            input.setCustomValidity('El número de documento debe tener exactamente 8 dígitos.');
        }
    }

    function validarTelefono(input) {
        const regex = /^\d{0,9}$/;
        if (!regex.test(input.value)) {
            input.value = input.value.slice(0, -1);
        }
        if (input.value.length === 9) {
            input.setCustomValidity('');
        } else {
            input.setCustomValidity('El número de teléfono debe tener exactamente 9 dígitos.');
        }
    }

    function updateProgressBar(percentage) {
        var progressBar = document.getElementById('progressBar');
        progressBar.style.width = percentage + '%';
        progressBar.setAttribute('aria-valuenow', percentage);
        progressBar.innerText = percentage + '%';
    }

    function descargarPlantilla() {
        const workbook = new ExcelJS.Workbook();
        const worksheet = workbook.addWorksheet('Plantilla');

        // Añadir el título
        const titleRow = worksheet.addRow(['USAT - Docentes']);
        worksheet.mergeCells('A1', 'D1');
        titleRow.font = { bold: true, size: 14 };
        titleRow.alignment = { horizontal: 'center', vertical: 'middle' };
        worksheet.getRow(1).height = 20;

        // Añadir las cabeceras
        const headerRow = worksheet.addRow(['Nombres', 'Apellidos', 'DNI', 'Teléfono', 'Correo', 'Cantidad de horas', 'Tiempo de refrigerio']);
        headerRow.font = { bold: false };
        headerRow.alignment = { horizontal: 'center', vertical: 'middle' };

        // Ajustar el ancho de las columnas
        worksheet.columns = [
            { key: 'nombres', width: 20 },
            { key: 'apellidos', width: 20 },
            { key: 'n_documento', width: 10 },
            { key: 'telefono', width: 10 },
            { key: 'correo', width: 20 },
            { key: 'cantHoras', width: 15 },
            { key: 'tiempo_ref', width: 15 }
        ];

        // Generar y guardar el archivo
        workbook.xlsx.writeBuffer().then(function (buffer) {
            saveAs(new Blob([buffer], { type: 'application/octet-stream' }), 'USAT_Docentes_Plantilla.xlsx');
        });
    }

    $(document).ready(function () {
        var docentes = [];

        function initializeDataTable() {
            var table = $('#tabla-docente').DataTable({
                paging: false,
                info: false,
                responsive: true,
                autoWidth: true,
                searching: true,
                scrollY: "510px",
                order: [],
                dom: 'Bfrtip',
                buttons: [
                    {
                        extend: 'collection',
                        text: '<i class="fas fa-file-import"></i> Importar',
                        className: 'btn btn-secondary',
                        buttons: [
                            {
                                text: '<i class="fas fa-upload"></i> Subir Archivo',
                                className: 'dropdown-item',
                                action: function (e) {
                                    e.preventDefault();
                                    $('#modalSubidaMasiva').modal('show');
                                }
                            },
                            {
                                text: '<i class="fas fa-download"></i> Descargar Plantilla',
                                className: 'dropdown-item',
                                action: function (e) {
                                    e.preventDefault();
                                    descargarPlantilla();
                                }
                            }
                        ]
                    },
                    {
                        extend: 'collection',
                        text: '<i class="fas fa-file-export"></i> Exportar/Imprimir',
                        className: 'btn btn-secondary',
                        buttons: [
                            {
                                extend: 'copy',
                                text: '<i class="fas fa-copy"></i> Copiar',
                                className: 'dropdown-item',
                                exportOptions: {
                                    columns: ':not(:last-child)'
                                }
                            },
                            {
                                extend: 'csv',
                                text: '<i class="fas fa-file-csv"></i> CSV',
                                className: 'dropdown-item',
                                exportOptions: {
                                    columns: ':not(:last-child)'
                                }
                            },
                            {
                                extend: 'excel',
                                text: '<i class="fas fa-file-excel"></i> Excel',
                                className: 'dropdown-item',
                                exportOptions: {
                                    columns: ':not(:last-child)'
                                },
                                customize: function (xlsx) {
                                    var sheet = xlsx.xl.worksheets['sheet1.xml'];

                                    // Modificar estilo de la primera y segunda fila
                                    $('row:nth-child(1) c', sheet).each(function () {
                                        $(this).attr('s', '32');
                                    });

                                    $('row:nth-child(2) c', sheet).each(function () {
                                        $(this).attr('s', '32');
                                    });
                                }
                            }

                            ,
                            {
                                extend: 'pdfHtml5',
                                text: '<i class="far fa-file-pdf"></i> PDF',
                                className: 'dropdown-item',
                                exportOptions: {
                                    columns: ':not(:last-child)'
                                },
                                orientation: 'portrait', // O 'landscape'
                                pageSize: 'A4',
                                customize: function (doc) {


                                    var imageUrl = 'static/login/images/usat_logo_red.png';
                                    // Ajustar márgenes para que la tabla ocupe toda la página
                                    doc.pageMargins = [20, 10, 20, 20]; // [superior, derecha, inferior, izquierda]

                                    // Personalizar el contenido del PDF
                                    doc.content[0].text = 'REPORTE DE DOCENTES';

                                    // Cambiar el estilo de la tabla
                                    doc.styles.tableHeader = {
                                        fillColor: '#E33439',
                                        color: 'white',
                                        fontSize: 12,
                                        bold: true
                                    };

                                    doc.styles.table = {
                                        fillColor: '#ffffff',
                                        fontSize: 10
                                    };

                                    var body = doc.content[1].table.body;
                                   

                                    // Ajustar la tabla para que no tenga bordes
                                    doc.content[1].layout = {
                                        hLineWidth: function (i, node) { return 0; },
                                        vLineWidth: function (i, node) { return 0; },
                                        paddingLeft: function (i) { return 8; },
                                        paddingRight: function (i) { return 8; },
                                        paddingTop: function (i) { return 8; },
                                        paddingBottom: function (i) { return 8; },
                                        fillColor: function (rowIndex, node, columnIndex) { return null; }
                                    };
                                }
                            },
                            {
                                extend: 'print',
                                text: '<i class="fas fa-print"></i> Imprimir',
                                className: 'dropdown-item',
                                exportOptions: {
                                    columns: ':not(:last-child)'
                                },
                                customize: function (win) {
                                    // Agregar un encabezado personalizado al documento de impresión
                                    $(win.document.body).prepend(
                                        '<h1 style="text-align:center;">REPORTE DE DOCENTES</h1>'
                                    );

                                    // Ajustar el estilo de la tabla en el documento de impresión
                                    $(win.document.body).find('table').addClass('display').css('font-size', '10px');
                                    $(win.document.body).find('thead th').css({
                                        'background-color': '#E33439',
                                        'color': 'white'
                                    });

                                    // Configurar el tamaño de página A4 vertical
                                    $(win.document.body).find('html').css({
                                        'font-size': '12px',
                                        'margin': '0',
                                        'padding': '0',
                                        'width': '210mm',  // Ancho para tamaño A4
                                        'height': '297mm', // Alto para tamaño A4
                                        'overflow': 'auto' // Para manejar contenido largo
                                    });

                                    $(win.document.body).find('body').css({
                                        'font-size': '12px',
                                        'margin': '20mm 10mm 10mm 10mm'  // Márgenes recomendados para impresión
                                    });
                                }
                            }


                        ]
                    },
                    {
                        text: '<i class="fas fa-plus"></i> Agregar Nuevo Docente',
                        className: 'btn_agregar_docente',
                        action: function (e) {
                            e.preventDefault();
                            $('#formAgregarDocente')[0].reset();
                            $('#modalAgregarDocente').modal('show');
                        }
                    }
                ],
                ajax: {
                    url: "/datos_docentes",
                    type: "GET",
                    dataSrc: ""
                },
                processing: true,
                serverSide: false,
                columns: [
                    { data: "docente" },
                    { data: "correo", className: 'dt-body-center' },
                    { data: "telefono", className: 'dt-body-center' },
                    {
                        data: null, className: 'dt-body-center',
                        render: function (data, type, row) {
                            return `
                                <button class="btn btn-warning btn-sm btnModificar" data-id="${row.idpersona}" title="Modificar"><i class="fas fa-pencil-alt"></i></button>
                                <button class="btn btn-danger btn-sm btnEliminar" data-id="${row.idpersona}" data-nombre="${row.docente}" title="Eliminar"><i class="fas fa-times"></i></button>
                            `;
                        }
                    }
                ],
                language: {
                    url: "https://cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json"
                }
            });

            $('#search_box').on('keyup', function () {
                table.search(this.value).draw();
            });

            return table;
        }

        var table;
        if ($.fn.DataTable.isDataTable('#tabla-docente')) {
            table = $('#tabla-docente').DataTable();
            table.ajax.reload();
        } else {
            table = initializeDataTable();
        }

        function mostrarAlerta(tipo, titulo, mensaje) {
            Swal.fire({
                icon: tipo,
                title: titulo,
                html: mensaje,
                showConfirmButton: true,
                timer: 5000
            });
        }

        $('#formSubidaMasiva').submit(function (e) {
            e.preventDefault();
            var fileInput = document.getElementById('archivo');
            var file = fileInput.files[0];
            updateProgressBar(0);
            procesarArchivo(file);
        });

        async function procesarArchivo(file) {
            var reader = new FileReader();
            reader.onload = async function (e) {

                var data = new Uint8Array(e.target.result);
                var workbook = XLSX.read(data, { type: 'array' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                var headers = jsonData[1];
                var rows = jsonData.slice(2);

                var formattedData = await Promise.all(rows.map(async (row, index) => {
                    updateProgressBar(Math.round((index + 1) / rows.length * 100)); // Actualizar barra de progreso
                    return {
                        nombres: row[headers.indexOf("Nombres")],
                        apellidos: row[headers.indexOf("Apellidos")],
                        n_documento: row[headers.indexOf("DNI")],
                        telefono: row[headers.indexOf("Teléfono")],
                        correo: row[headers.indexOf("Correo")],
                        tipopersona: "D",
                        cantHoras: row[headers.indexOf("Cantidad de horas")],
                        tiempo_ref: row[headers.indexOf("Tiempo de refrigerio")],
                        estado: 1
                    };
                }));

                //console.log(JSON.stringify(formattedData, null, 2)); // Visualizar los datos en forma de JSON en la consola

                $.ajax({
                    url: '/asignar_docentes_excel',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(formattedData),
                    success: function (response) {
                        if (response.error) {
                            Swal.fire('Error', response.error, 'error');
                        } else {
                            Swal.fire('Éxito', 'La subida masiva se realizó correctamente.', 'success');
                            table.ajax.reload();
                            $('#modalSubidaMasiva').modal('hide');
                        }
                    },
                    error: function (xhr, status, error) {
                        Swal.fire('Error', 'Hubo un error al realizar la operación.', 'error');
                    }
                });

            };
            reader.readAsArrayBuffer(file);
        }

        $('#btn_agregar_docente').click(function (e) {
            e.preventDefault();
            $('#modalAgregarDocente').modal('show');
            $('#formAgregarDocente')[0].reset();
        });

        $('#formAgregarDocente').submit(function (e) {
            e.preventDefault();
            var data = {
                nombres: $('#nombreDocente').val(),
                apellidos: $('#apellidosDocente').val(),
                n_documento: $('#documentoDocente').val(),
                telefono: $('#telefonoDocente').val(),
                correo: $('#correoDocente').val(),
                cantHoras: $('#cantHorasDocente').val(),
                tiempo_ref: $('#tiempoRefDocente').val(),
                estado: $('#estadoDocente').val()
            };

            $.ajax({
                url: '/agregar_docente',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function (response) {
                    if (response.error) {
                        Swal.fire('Error', response.error, 'error');
                    } else {
                        Swal.fire('Éxito', 'Docente agregado correctamente', 'success');
                        table.ajax.reload();
                        $('#modalAgregarDocente').modal('hide');
                    }
                    $('#mensajeResultado').show();
                },
                error: function (xhr, status, error) {
                    Swal.fire('Error', 'Hubo un error al agregar el docente', 'error');
                }
            });
        });

        $('#formModificarDocente').submit(function (e) {
            e.preventDefault();
            var data = {
                idpersona: $('#modificarIdDocente').val(),
                nombres: $('#modificarNombreDocente').val(),
                apellidos: $('#modificarApellidosDocente').val(),
                n_documento: $('#modificarDocumentoDocente').val(),
                telefono: $('#modificarTelefonoDocente').val(),
                correo: $('#modificarCorreoDocente').val(),
                cantHoras: $('#modificarCantHoras').val(),
                tiempo_ref: $('#modificarTiempoRef').val(),
                estado: $('#modificarEstadoDocente').val()
            };

            $.ajax({
                url: '/modificar_docente',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function (response) {
                    if (response.error) {
                        Swal.fire('Error', response.error, 'error');
                    } else {
                        Swal.fire('Éxito', 'Docente modificado correctamente', 'success');
                        table.ajax.reload();
                        $('#modalModificarDocente').modal('hide');
                    }
                    $('#mensajeResultado').show();
                },
                error: function (xhr, status, error) {
                    console.log(error);
                }
            });
        });

        $('#tabla-docente tbody').on('click', '.btnModificar', function () {
            var id = $(this).data('id');
            console.log(id);
            $.ajax({
                url: '/obtener_docente_por_id/' + id,
                type: 'GET',
                contentType: 'application/json',
                success: function (response) {
                    var docente = response;
                    $('#modificarIdDocente').val(docente.idpersona);
                    $('#modificarNombreDocente').val(docente.nombres);
                    $('#modificarApellidosDocente').val(docente.apellidos);
                    $('#modificarDocumentoDocente').val(docente.n_documento);
                    $('#modificarTelefonoDocente').val(docente.telefono);
                    $('#modificarCorreoDocente').val(docente.correo);
                    $('#modificarCantHoras').val(docente.cantHoras);
                    $('#modificarTiempoRef').val(docente.tiempo_ref);
                    $('#modificarEstadoDocente').val(docente.estado);
                    $('#modalModificarDocente').modal('show');
                },
                error: function (xhr, status, error) {
                    console.log(error);
                }
            });
        });

        $('#tabla-docente tbody').on('click', '.btnEliminar', function () {
            var id = $(this).data('id');
            var nombre = $(this).data('nombre');
            Swal.fire({
                title: `¿Seguro que quieres eliminar el docente: ${nombre}?`,
                text: "No podrás revertir esta acción.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, eliminarlo!',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '/eliminar_docente',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({ idpersona: id }),
                        success: function (response) {
                            if (response.error) {
                                Swal.fire('Error', response.error, 'error');
                            } else {
                                Swal.fire('Éxito', 'La operación se realizó correctamente.', 'success');
                                table.ajax.reload();
                            }
                        },
                        error: function (xhr, status, error) {
                            Swal.fire('Error', 'Hubo un error al eliminar el docente', 'error');
                        }
                    });
                }
            });
        });

    });
</script>
{% endblock %}