{% extends "dashboard/index.html" %}
{% block titulo %} Cursos {% endblock %}
{% block contenido %}

<head>
    <style>
        .xl32 {
            font-weight: bold;
            font-size: 12pt;
            text-align: center;
            vertical-align: middle;
            background-color: red;
            /* Gris */
            color: white;
        }
    </style>
</head>
<nav style="--bs-breadcrumb-divider: '>'" aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Inicio</a></li>
        <li class="breadcrumb-item active"><a href="{{ url_for('cursos') }}">Cursos</a></li>
    </ol>
</nav>

<div class="container-fluid my-4">
    <div class="card w-100">
        <div class="card-header bg-red-usat text-white" id="headingOne" data-bs-toggle="collapse"
            data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
            Cursos
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table id="tabla-curso" class="table table-striped tabla-cursos tabla-comun" style="width:100%">
                    <thead>
                        <tr>
                            <th style=" text-align:center;">Nombre Curso</th>
                            <th style=" text-align:center;">Ciclo</th>
                            <th style=" text-align:center;">Tipo Curso</th>
                            <th style=" text-align:center;">Estado</th>
                            <th style=" text-align:center;">Plan de Estudio</th>
                            <th style=" text-align:center;">Opciones</th>
                        </tr>
                    </thead>
                    <tbody>

                    </tbody>
                </table>
            </div>

        </div>
    </div>
</div>

<!-- MODAL CURSO -->
<div class="modal fade" id="modalCurso" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalCursoTitulo">Agregar Curso</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formCurso">
                    <div class="mb-3">
                        <label for="nombreCurso" class="form-label">Nombre:</label>
                        <input type="text" class="form-control" id="nombreCurso" name="nombreCurso" required>
                    </div>
                    <div class="mb-3">
                        <label for="codigoCurso" class="form-label">Código:</label>
                        <input type="text" class="form-control" id="codigoCurso" name="codigoCurso" required>
                    </div>
                    <div class="mb-3">
                        <label for="creditosCurso" class="form-label">Créditos:</label>
                        <input type="number" class="form-control" id="creditosCurso" name="creditosCurso" required min="1" max="4">
                    </div>
                    <div class="mb-3">
                        <label for="horasTeoriaCurso" class="form-label">Horas Teoría:</label>
                        <input type="number" class="form-control" id="horasTeoriaCurso" name="horasTeoriaCurso" required min="1" max="4">
                    </div>
                    <div class="mb-3">
                        <label for="horasPracticaCurso" class="form-label">Horas Práctica:</label>
                        <input type="number" class="form-control" id="horasPracticaCurso" name="horasPracticaCurso" required min="1" max="4">
                    </div>
                    <div class="mb-3">
                        <label for="cicloCurso" class="form-label">Ciclo:</label>
                        <input type="text" class="form-control" id="cicloCurso" name="cicloCurso" required>
                    </div>
                    <div class="mb-3">
                        <label for="tipoCurso" class="form-label">Tipo de Curso:</label>
                        <select class="form-control" id="tipoCurso" name="tipoCurso" required>
                            <option value="0">Presencial</option>
                            <option value="1">Virtual</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="estadoCurso" class="form-label">Estado:</label>
                        <select class="form-control" id="estadoCurso" name="estadoCurso" required>
                            <option value="A">Activo</option>
                            <option value="I">Inactivo</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="planEstudioCurso" class="form-label">Plan de Estudio:</label>
                        <select class="form-control" id="planEstudioCurso" name="planEstudioCurso" required>
                            <!-- Opciones de planes de estudio cargadas dinámicamente -->
                        </select>
                    </div>
                    <input type="hidden" id="idCurso" name="idCurso">
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        var cursos = [];
        var planEstudioMap = {};
        var table;

        function cargarPlanesDeEstudio(selectElementId, selectedValue = null) {
            $.ajax({
                url: '/obtener_planes_estudio',
                type: 'GET',
                contentType: 'application/json',
                success: function (response) {
                    var select = $(selectElementId);
                    select.empty();
                    select.append($('<option>', { value: '', text: 'Seleccione un plan de estudio' }));

                    planEstudioMap = response.reduce((acc, plan) => {
                        acc[plan.nombre] = plan.id_plan_estudio;
                        select.append($('<option>', {
                            value: plan.id_plan_estudio,
                            text: plan.nombre
                        }));
                        return acc;
                    }, {});

                    if (selectedValue) {
                        select.val(selectedValue);
                    }
                },
                error: function (xhr, status, error) {
                    console.log('Error al cargar los planes de estudio:', error);
                }
            });
        }

        if ($.fn.DataTable.isDataTable('#tabla-curso')) {
            table = $('#tabla-curso').DataTable();
        } else {
            table = initializeDataTable();
        }

        function initializeDataTable() {
            return $('#tabla-curso').DataTable({

                paging: false,
                info: false,
                responsive: true,
                autoWidth: true,
                searching: true,
                scrollY: "600px",
                order: [[0, 'asc']], 
                columnDefs: [
                    { type: 'locale-compare', targets: 0 }
                ],
                dom: 'Bfrtip',
                buttons: [
                    {
                        extend: 'collection',
                        text: '<i class="fas fa-file-import"></i> Importar/ Plantilla',
                        className: 'btn btn-secondary',
                        buttons: [
                            {
                                text: '<i class="fas fa-upload"></i> Subir Archivo',
                                className: 'dropdown-item',
                                action: function (e) {
                                    e.preventDefault();
                                    $('#modalSubidaMasiva').modal('show');
                                }
                            },
                            {
                                text: '<i class="fas fa-download"></i> Descargar Plantilla',
                                className: 'dropdown-item',
                                action: function (e) {
                                    e.preventDefault();
                                    descargarPlantilla();
                                }
                            },
                        ]
                    },
                    {
                        extend: 'collection',
                        text: '<i class="fas fa-file-export"></i> Exportar/Imprimir',
                        className: 'btn btn-secondary',
                        buttons: [
                            {
                                extend: 'copy',
                                text: '<i class="fas fa-copy"></i> Copiar',
                                className: 'dropdown-item',
                                exportOptions: {
                                    columns: ':not(:last-child)'
                                }
                            },
                            {
                                extend: 'csv',
                                text: '<i class="fas fa-file-csv"></i> CSV',
                                className: 'dropdown-item',
                                exportOptions: {
                                    columns: ':not(:last-child)'
                                }
                            },
                            {
                                extend: 'excel',
                                text: '<i class="fas fa-file-excel"></i> Excel',
                                className: 'dropdown-item',
                                exportOptions: {
                                    columns: ':not(:last-child)'
                                },
                                customize: function (xlsx) {
                                    var sheet = xlsx.xl.worksheets['sheet1.xml'];

                                    // Modificar estilo de la primera y segunda fila
                                    $('row:nth-child(1) c', sheet).each(function () {
                                        $(this).attr('s', '32');
                                    });

                                    $('row:nth-child(2) c', sheet).each(function () {
                                        $(this).attr('s', '32');
                                    });
                                }
                            }

                            ,
                            {
                                extend: 'pdfHtml5',
                                text: '<i class="far fa-file-pdf"></i> PDF',
                                className: 'dropdown-item',
                                exportOptions: {
                                    columns: ':not(:last-child)'
                                },
                                orientation: 'portrait', // O 'landscape'
                                pageSize: 'A4',
                                customize: function (doc) {


                                    var imageUrl = 'static/login/images/usat_logo_red.png';
                                    // Ajustar márgenes para que la tabla ocupe toda la página
                                    doc.pageMargins = [20, 10, 20, 20]; // [superior, derecha, inferior, izquierda]

                                    // Personalizar el contenido del PDF
                                    doc.content[0].text = 'REPORTE DE CURSOS';
                                    
                                    // Cambiar el estilo de la tabla
                                    doc.styles.tableHeader = {
                                        fillColor: '#E33439',
                                        color: 'white',
                                        fontSize: 12,
                                        bold: true
                                    };

                                    doc.styles.table = {
                                        fillColor: '#ffffff',
                                        fontSize: 10
                                    };

                                    var body = doc.content[1].table.body;
                                    body.forEach(function (row) {
                                        var TipoCursoIndex = 2; // posición de la columna
                                        var fillColor;
                                        if (row[TipoCursoIndex].text == 'VIRTUAL') {
                                            fillColor = '#90EE90'; // Verde
                                        } else if (row[TipoCursoIndex].text == 'PRESENCIAL') {
                                            fillColor = '#00FFFF'; // Azul
                                        }

                                        if (fillColor) {
                                            row.forEach(function (cell) {
                                                cell.fillColor = fillColor;
                                            });
                                        }
                                    });

                                    // Ajustar la tabla para que no tenga bordes
                                    doc.content[1].layout = {
                                        hLineWidth: function (i, node) { return 0; },
                                        vLineWidth: function (i, node) { return 0; },
                                        paddingLeft: function (i) { return 8; },
                                        paddingRight: function (i) { return 8; },
                                        paddingTop: function (i) { return 8; },
                                        paddingBottom: function (i) { return 8; },
                                        fillColor: function (rowIndex, node, columnIndex) { return null; }
                                    };
                                }
                            }
                            ,
                            {
                                extend: 'print',
                                text: '<i class="fas fa-print"></i> Imprimir',
                                className: 'dropdown-item',
                                exportOptions: {
                                    columns: ':not(:last-child)'
                                },
                                customize: function (win) {
                                    // Agregar un encabezado personalizado al documento de impresión
                                    $(win.document.body).prepend(
                                        '<h1 style="text-align:center;">REPORTE DE CURSOS</h1>'
                                    );

                                    // Ajustar el estilo de la tabla en el documento de impresión
                                    $(win.document.body).find('table').addClass('display').css('font-size', '10px');
                                    $(win.document.body).find('thead th').css({
                                        'background-color': '#E33439',
                                        'color': 'white'
                                    });

                                    // Configurar el tamaño de página A4
                                    $(win.document.body).find('html').css({
                                        'font-size': '12px',
                                        'margin': '0',
                                        'padding': '0',
                                        'width': '297mm',  // Ancho para tamaño A4
                                        'height': '217mm'  // Alto para tamaño A4
                                    });

                                    $(win.document.body).find('body').css({
                                        'font-size': '12px',
                                        'margin': '20mm 10mm 10mm 10mm'  // Márgenes recomendados para impresión
                                    });
                                }
                            }

                        ]
                    },
                    {
                        text: '<i class="fas fa-plus"></i> Agregar Nuevo Curso',
                        className: 'btn_agregar_curso',
                        action: function (e) {
                            e.preventDefault();
                            $('#formCurso')[0].reset();
                            cargarPlanesDeEstudio('#planEstudioCurso');
                            $('#modalCursoTitulo').text('Agregar Curso');
                            $('#modalCurso').modal('show');
                        }
                    }
                ],
                ajax: {
                    url: "/datos_cursos",
                    type: "GET",
                    dataSrc: ""
                },
                processing: true,
                serverSide: false,
                columns: [
                    { data: "nombre" },
                    { data: "ciclo", className: 'dt-body-center' },
                    { data: "tipo_curso", className: 'dt-body-center' },
                    {
                        "data": "estado", className: "dt-body-center",
                        "render": function (data, type, row) {
                            return data === 'A' ? 'ACTIVO' : data === 'I' ? 'INACTIVO' : data;
                        }
                    },
                    { data: "nombre_plan_estudio", className: 'dt-body-center' },
                    {
                        data: null, className: 'dt-body-center',
                        render: function (data, type, row) {
                            var darDeBajaIcono = row.estado === 'A' ? 'fas fa-arrow-down' : 'fas fa-arrow-up';
                            var darDeBajaTitulo = row.estado === 'A' ? 'Dar de Baja' : 'Activar';
                            return `
                                <button class="btn btn-primary btn-sm btnVer" data-id="${row.idcurso}" title="Ver"><i class="fas fa-eye"></i></button>
                                <button class="btn btn-warning btn-sm btnModificar" data-id="${row.idcurso}" title="Modificar"><i class="fas fa-pencil-alt"></i></button>
                                <button class="btn btn-danger btn-sm btnEliminar" data-id="${row.idcurso}" data-nombre="${row.nombre}" title="Eliminar"><i class="fas fa-times"></i></button>
                                <button class="btn btn-secondary btn-sm btnCambiarEstado" data-id="${row.idcurso}" title="${darDeBajaTitulo}"><i class="${darDeBajaIcono}"></i></button>
                            `;
                        }
                    }
                ],
                language: {
                    url: "https://cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json"
                }
            });
        }

        $('#search_box').on('keyup', function () {
            table.search(this.value).draw();
        });

        cargarPlanesDeEstudio();

        function mostrarAlerta(tipo, titulo, mensaje) {
            Swal.fire({
                icon: tipo,
                title: titulo,
                html: mensaje,
                showConfirmButton: true,
                timer: 5000
            });
        }

        $('#tabla-curso tbody').on('click', '.btnVer', function () {
            var id = $(this).data('id');
            $.ajax({
                url: '/ver_cursos/' + id,
                type: 'GET',
                contentType: 'application/json',
                success: function (response) {
                    if (response.error) {
                        alert(response.error);
                    } else {
                        $('#modalVerCurso .modal-body').html(`
                            <table class="table table-striped table-bordered">
                                <tr><th>Nombre</th><td>${response.nombre}</td></tr>
                                <tr><th>Código</th><td>${response.cod_curso}</td></tr>
                                <tr><th>Créditos</th><td>${response.creditos}</td></tr>
                                <tr><th>Horas Teoría</th><td>${response.horas_teoria}</td></tr>
                                <tr><th>Horas Práctica</th><td>${response.horas_practica}</td></tr>
                                <tr><th>Ciclo</th><td>${response.ciclo}</td></tr>
                                <tr><th>Tipo</th><td>${response.tipo_curso}</td></tr>
                                <tr><th>Estado</th><td>${response.estado}</td></tr>
                                <tr><th>Plan de Estudio</th><td>${response.nombre_plan_estudio}</td></tr>
                            </table>
                        `);
                        $('#modalVerCurso').modal('show');
                    }
                },
                error: function (xhr, status, error) {
                    console.log(error);
                }
            });
        });

        $('#formCurso').submit(function (e) {
            e.preventDefault();
            var data = {
                idcurso: $('#idCurso').val(),
                nombre: $('#nombreCurso').val(),
                cod_curso: $('#codigoCurso').val(),
                creditos: $('#creditosCurso').val(),
                horas_teoria: $('#horasTeoriaCurso').val(),
                horas_practica: $('#horasPracticaCurso').val(),
                ciclo: $('#cicloCurso').val(),
                tipo_curso: $('#tipoCurso').val(),
                estado: $('#estadoCurso').val(),
                id_plan_estudio: $('#planEstudioCurso').val()
            };

            var url = data.idcurso ? '/modificar_curso' : '/agregar_curso';
            var mensajeExito = data.idcurso ? 'Curso modificado correctamente' : 'Curso agregado correctamente';

            $.ajax({
                url: url,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function (response) {
                    if (response.error) {
                        Swal.fire('Error', response.error, 'error');
                    } else {
                        Swal.fire('Éxito', mensajeExito, 'success');
                        table.ajax.reload();
                        $('#modalCurso').modal('hide');
                    }
                },
                error: function (xhr, status, error) {
                    Swal.fire('Error', 'Hubo un error al guardar el curso', 'error');
                }
            });
        });

        $('#tabla-curso tbody').on('click', '.btnEliminar', function () {
            var id = $(this).data('id');
            var nombre = $(this).data('nombre');
            Swal.fire({
                title: `¿Seguro que quieres eliminar el curso: ${nombre}?`,
                text: "No podrás revertir esta acción.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, eliminarlo!',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '/eliminar_curso',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({ idcurso: id }),
                        success: function (response) {
                            if (response.error) {
                                Swal.fire('Error', response.error, 'error');
                            } else {
                                Swal.fire('Éxito', 'La operación se realizó correctamente.', 'success');
                                table.ajax.reload();
                            }
                        },
                        error: function (xhr, status, error) {
                            Swal.fire('Error', 'Hubo un error al eliminar el curso', 'error');
                        }
                    });
                }
            });
        });

        $('#tabla-curso tbody').on('click', '.btnModificar', function () {
            var id = $(this).data('id');
            $.ajax({
                url: '/obtener_curso/' + id,
                type: 'GET',
                contentType: 'application/json',
                success: function (response) {
                    var curso = response;
                    $('#idCurso').val(curso.idcurso);
                    $('#nombreCurso').val(curso.nombre);
                    $('#codigoCurso').val(curso.cod_curso);
                    $('#creditosCurso').val(curso.creditos);
                    $('#horasTeoriaCurso').val(curso.horas_teoria);
                    $('#horasPracticaCurso').val(curso.horas_practica);
                    $('#cicloCurso').val(curso.ciclo);
                    $('#tipoCurso').val(curso.tipo_curso);
                    $('#estadoCurso').val(curso.estado);
                    cargarPlanesDeEstudio('#planEstudioCurso', curso.id_plan_estudio);
                    $('#modalCursoTitulo').text('Modificar Curso');
                    $('#modalCurso').modal('show');
                },
                error: function (xhr, status, error) {
                    Swal.fire('Error', 'Hubo un error al obtener los datos del curso', 'error');
                }
            });
        });

        function cambiarEstadoCurso(id, estadoActual) {
            var nuevoEstado = estadoActual === 'A' ? 'I' : 'A';
            $.ajax({
                url: '/curso_estado',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ idcurso: id, estado: nuevoEstado }),
                success: function (response) {
                    if (response.error) {
                        Swal.fire('Error', response.error, 'error');
                    } else {
                        Swal.fire('Éxito', 'El estado del curso ha sido actualizado.', 'success');
                        table.ajax.reload(function (json) {
                            console.log('Datos recargados después de la actualización:', json);
                        }, false);
                    }
                },
                error: function (xhr, status, error) {
                    Swal.fire('Error', 'Hubo un error al cambiar el estado del curso', 'error');
                }
            });
        }

        $('#tabla-curso tbody').on('click', '.btnCambiarEstado', function () {
            var id = $(this).data('id');
            var estadoActual = $(this).attr('title') === 'Dar de Baja' ? 'A' : 'I';

            Swal.fire({
                title: `¿Seguro que quieres ${estadoActual === 'A' ? 'dar de baja' : 'activar'} este curso?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: `Sí, ${estadoActual === 'A' ? 'dar de baja' : 'activar'}!`,
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    cambiarEstadoCurso(id, estadoActual);
                }
            });
        });
    });
</script>



{% endblock %}
