{% extends "dashboard/index.html" %}

{% block titulo %} Horarios {% endblock %}

{% block contenido %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/locale/es.js"></script>

<nav style="--bs-breadcrumb-divider: '>'" aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item" href="Home"><a>Inicio</a></li>
        <li class="breadcrumb-item active" data-href="#"><a>Horarios</a></li>
    </ol>
</nav>

<div class="card mx-2" id="card_horarios">
    <div class="card-header bg-red-usat text-white" id="headingOne" data-bs-toggle="collapse"
        data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
        Generar Horarios Academicos
    </div>
    <div id="collapseOne" class="collapse show" aria-labelledby="headingOne" data-bs-parent="#miAccordion">
        <div class="card-body">
            <div class="my-3">
                <div id="estadoGeneracion">
                    <!-- Estado de generación aquí -->
                    <div id="estadoGeneracion">
                        <!-- <div class="d-flex align-items-center mb-2">
                            <div class="spinner-border spinner-border-sm text-success me-2" role="status" id="spinner1">
                            </div>
                            <div id="estadoDisponibilidad">Disponibilidad de docentes</div>
                        </div> -->
                        <div class="d-flex align-items-center mb-2">
                            <div class="spinner-border spinner-border-sm text-success me-2" role="status" id="spinner2">
                            </div>
                            <div id="estadoCursosActivos">Cursos activos</div>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <div class="spinner-border spinner-border-sm text-success me-2" role="status" id="spinner3">
                            </div>
                            <div id="estadoAmbientesDisponibles">Ambientes asignados</div>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <div class="spinner-border spinner-border-sm text-success me-2" role="status" id="spinner4">
                            </div>
                            <div id="estadoMinimoHorasAsignado">Mínimo de horas asignado</div>
                        </div>
                        <!-- <div class="d-flex align-items-center mb-2">
                            <div class="spinner-border spinner-border-sm text-success me-2" role="status" id="spinner5">
                            </div>
                            <div id="get_docentes_no_asignados">Docentes asignados a grupos</div>
                        </div> -->
                    </div>
                </div>
            </div>
            <!-- Botones -->
            <div class="row align-items-end my-3">
                <div class="d-flex justify-content-center mt-3">
                    <button class="btn btn-success btn-lg mx-2" onclick="generarHorario()"><i
                            class="fa fa-robot me-2"></i> Generar Horario</button>
                    <button class="btn btn-success btn-lg mx-2 d-none" id="btnRegistrar"
                        onclick="confirmarRegistrarHorario()">
                        <i class="fa fa-save me-2"></i>Registrar Horario
                    </button>
                    <button class="btn btn-danger btn-lg mx-2 d-none" id="btnLimpiar" onclick="limpiarTabla()">
                        <i class="fa fa-trash me-2"></i>Limpiar
                    </button>
                </div>
                <div class="d-flex justify-content-center mt-3">
                    <button class="btn btn-secondary btn-lg mx-2" onclick="cicloAnterior()"><i
                            class="fa fa-arrow-left me-2"></i>Anterior</button>
                    <h4 class="mx-3" id="cicloActual">I Ciclo</h4>
                    <button class="btn btn-secondary btn-lg mx-2" onclick="cicloSiguiente()"><i
                            class="fa fa-arrow-right me-2"></i>Siguiente</button>
                </div>
            </div>
            <!-- Calendario -->
            <div class="card-body show" style="max-height: 600px; overflow-y: auto;">
                <div id="calendar"></div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Carga -->
<div class="modal fade" id="loadingModal" tabindex="-1" aria-labelledby="loadingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="spinner-border text-success" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Generando Horario, por favor espere...</p>
            </div>
        </div>
    </div>
</div>

<style>
    .curso-tipo-presencial {
        background-color: rgb(0, 38, 255);
        color: white;
        font-weight: bold;
        padding: 2px;
        margin-top: 2px;
        margin-bottom: 2px;
    }

    .curso-tipo-virtual {
        background-color: rgb(255, 0, 0);
        color: white;
        font-weight: bold;
        padding: 2px;
        margin-top: 2px;
        margin-bottom: 2px;
    }
</style>

<script>
    var currentCiclo = 1;
    var maxCiclo = 1;
    var allEvents = [];
    var horariosgenerado = [];

    $(document).ready(function () {
        verificarDisponibilidadDocentes();
        verificarCursosActivos();
        verificarAmbientesDisponibles();
        verificarMinimoHorasAsignado();
        get_docentes_no_asignados();
    });
    function verificarDisponibilidadDocentes() {
        $.ajax({
            url: '/get_docente_sin_disponibilidad',
            type: 'GET',
            contentType: 'application/json',
            success: function (response) {
                console.log(response);
                if (response.length > 0) {
                    $('#spinner1').replaceWith('<i class="fa fa-exclamation-triangle text-danger me-2"></i>');
                    $('#estadoDisponibilidad').html('Hay Docentes sin disponibilidad Asignada <a href="/disponibilidad" class="btn btn-warning btn-sm ms-2">Ir a disponibilidad</a>');
                } else if (response.length == 0) {
                    $('#spinner1').replaceWith('<i class="fa fa-check text-success me-2"></i>');
                    $('#estadoDisponibilidad').text('Disponibilidad de docentes');
                }
            },
            error: function (xhr, status, error) {
                console.log(error);
                $('#spinner1').replaceWith('<i class="fa fa-exclamation-triangle text-danger me-2"></i>');
                $('#estadoDisponibilidad').text('Error al verificar disponibilidad de docentes');
            }
        });
    }

    function get_docentes_no_asignados() {
        $.ajax({
            url: '/get_docentes_no_asignados',
            type: 'GET',
            contentType: 'application/json',
            success: function (response) {
                if (response.length > 0) {
                    $('#spinner5').replaceWith('<i class="fa fa-exclamation-triangle text-danger me-2"></i>');
                    $('#get_docentes_no_asignados').html('Hay Docentes sin asignar grupos horarios <a href="/grupos_docente" class="btn btn-warning btn-sm ms-2">Resolver</a>');
                } else if (response.length == 0) {
                    $('#spinner5').replaceWith('<i class="fa fa-check text-success me-2"></i>');
                    $('#get_docentes_no_asignados').text('Docentes asignados a grupos');
                }
            },
            error: function (xhr, status, error) {
                console.log(error);
                $('#spinner1').replaceWith('<i class="fa fa-exclamation-triangle text-danger me-2"></i>');
                $('#get_docentes_no_asignados').text('Error al verificar asignacion de docentes a grupos');
            }
        });
    }

    function verificarCursosActivos() {
        $.ajax({
            url: '/get_cursos_activos',
            type: 'GET',
            contentType: 'application/json',
            success: function (response) {
                if (response.length > 0) {
                    $('#spinner2').replaceWith('<i class="fa fa-check text-success me-2"></i>');
                    $('#estadoCursosActivos').text('Cursos Activos');
                } else if (response.length == 0) {
                    $('#spinner2').replaceWith('<i class="fa fa-exclamation-triangle text-danger me-2"></i>');
                    $('#estadoCursosActivos').html('No hay cursos activos <a href="/cursos" class="btn btn-warning btn-sm ms-2">Ir a Cursos</a>');
                }
            },
            error: function (xhr, status, error) {
                console.log(error);
                $('#spinner2').replaceWith('<i class="fa fa-exclamation-triangle text-danger me-2"></i>');
                $('#estadoCursosActivos').text('Error al verificar cursos activos');
            }
        });
    }

    function verificarAmbientesDisponibles() {
        $.ajax({
            url: '/get_ambientes_disponibles',
            type: 'GET',
            contentType: 'application/json',
            success: function (response) {
                if (response.length > 0) {
                    $('#spinner3').replaceWith('<i class="fa fa-check text-success me-2"></i>');
                    $('#estadoAmbientesDisponibles').text('Ambientes asignados');
                } else if (response.length == 0) {
                    $('#spinner3').replaceWith('<i class="fa fa-exclamation-triangle text-danger me-2"></i>');
                    $('#estadoAmbientesDisponibles').html('No hay ambientes disponibles <a href="/ambientes" class="btn btn-warning btn-sm ms-2">Ir a Ambientes</a>');
                }
            },
            error: function (xhr, status, error) {
                console.log(error);
                $('#spinner3').replaceWith('<i class="fa fa-exclamation-triangle text-danger me-2"></i>');
                $('#estadoAmbientesDisponibles').text('Error al verificar ambientes disponibles');
            }
        });
    }

    function verificarMinimoHorasAsignado() {
        $.ajax({
            url: '/docentes_validar_horas',
            type: 'GET',
            contentType: 'application/json',
            success: function (response) {
                if (response.length == 0) {
                    $('#spinner4').replaceWith('<i class="fa fa-check text-success me-2"></i>');
                    $('#estadoMinimoHorasAsignado').text('Mínimo de Horas Asignado');
                } else if (response.length > 0) {
                    $('#spinner4').replaceWith('<i class="fa fa-exclamation-triangle text-danger me-2"></i>');
                    $('#estadoMinimoHorasAsignado').html('Docentes sin horas asignadas <a href="/docentes" class="btn btn-warning btn-sm ms-2">Ir a Docentes</a>');
                }
            },
            error: function (xhr, status, error) {
                console.log(error);
                $('#spinner4').replaceWith('<i class="fa fa-exclamation-triangle text-danger me-2"></i>');
                $('#estadoMinimoHorasAsignado').text('Error al verificar el mínimo de horas asignado');
            }
        });
    }

    function generarHorario() {
        $('#loadingModal').modal('show');
        $.ajax({
            url: '/generarHorario',
            type: 'GET',
            contentType: 'application/json',
            success: function (response) {
                $('#loadingModal').modal('hide');
                allEvents = response;
                maxCiclo = Math.max(...allEvents.map(event => event.ciclo));
                horariosgenerado = response;
                actualizarCalendario();
                $('#btnRegistrar').removeClass('d-none');
                $('#btnLimpiar').removeClass('d-none');
            },
            error: function (xhr, status, error) {
                console.log(error);
                $('#loadingModal').modal('hide');
            }
        });
    }

    function actualizarCalendario() {
        var events = allEvents.filter(event => event.ciclo === currentCiclo).map(function (curso) {
            return {
                title: curso.curso + ' (' + curso.docente + ')',
                start: moment().day(curso.dia).hour(parseInt(curso.hora_inicio.split(':')[0])).minute(parseInt(curso.hora_inicio.split(':')[1])),
                end: moment().day(curso.dia).hour(parseInt(curso.hora_fin.split(':')[0])).minute(parseInt(curso.hora_fin.split(':')[1])),
                className: curso.tipo_curso.toLowerCase() === 'presencial' ? 'curso-tipo-presencial' : 'curso-tipo-virtual'
            };
        });

        $('#calendar').fullCalendar('destroy'); // Destroy the existing calendar
        $('#calendar').fullCalendar({ // Create a new calendar
            header: false, // Hide navigation header
            defaultView: 'agendaWeek',
            locale: 'es',
            minTime: '07:00:00',
            maxTime: '24:00:00',
            hiddenDays: [0], // Hide Sundays
            events: events,
            editable: false,
            eventRender: function (event, element) {
                element.append("<span class='closeon'>X</span>");
                element.find(".closeon").click(function () {
                    $('#calendar').fullCalendar('removeEvents', event._id);
                });
            }
        });
        actualizarTituloCiclo();
    }

    function cicloAnterior() {
        if (currentCiclo > 1) {
            currentCiclo--;
            actualizarCalendario();
        }
    }

    function cicloSiguiente() {
        if (currentCiclo < maxCiclo) {
            currentCiclo++;
            actualizarCalendario();
        }
    }

    function actualizarTituloCiclo() {
        var cicloTitulo = ["I Ciclo", "II Ciclo", "III Ciclo", "IV Ciclo", "V Ciclo", "VI Ciclo", "VII Ciclo", "VIII Ciclo", "IX Ciclo", "X Ciclo"];
        document.getElementById("cicloActual").innerText = cicloTitulo[currentCiclo - 1];
    }

    function confirmarRegistrarHorario() {
        Swal.fire({
            title: '¿Está seguro?',
            text: "Está a punto de registrar el horario en la base de datos.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Sí, registrar',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                RegistrarHorario();
            }
        });
    }

    function RegistrarHorario() {
        Swal.fire({
            title: 'Registrando...',
            html: 'Por favor, espere mientras se registra el horario.',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        // var events = $('#calendar').fullCalendar('clientEvents');
        // var horario = events.map(event => ({
        //     curso: event.title.split(' (')[0],
        //     docente: event.title.split(' (')[1].slice(0, -1),
        //     dia: event.start.format('dddd'),
        //     hora_inicio: event.start.format('HH:mm'),
        //     hora_fin: event.end.format('HH:mm'),
        //     tipo_curso: event.className[0].includes('presencial') ? 'Presencial' : 'Virtual',
        //     ciclo: currentCiclo
        // }));

        $.ajax({
            url: '/insertar_horarios_ia',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ horariosgenerado: horariosgenerado }),
            success: function (response) {
                Swal.close();
                Swal.fire(
                    '¡Registrado!',
                    'El horario ha sido registrado exitosamente.',
                    'success'
                );
            },
            error: function (xhr, status, error) {
                Swal.close();
                Swal.fire(
                    'Error',
                    'Hubo un problema al registrar el horario. Por favor, inténtelo de nuevo.',
                    'error'
                );
            }
        });
    }

    function limpiarTabla() {
        $('#calendar').fullCalendar('removeEvents');
        $('#btnRegistrar').addClass('d-none');
        $('#btnLimpiar').addClass('d-none');
    }
</script>
{% endblock %}