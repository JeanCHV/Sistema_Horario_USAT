{% extends "dashboard/index.html" %}

{% block titulo %} Horarios {% endblock %}

{% block contenido %}
<script src="{{ url_for('static', filename='login/libs/sweetalert2/sweetalert2.js') }}"></script>

<nav style="--bs-breadcrumb-divider: '>'" aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item" href="Home"><a>Inicio</a></li>
        <li class="breadcrumb-item active" data-href="#"><a>Horarios</a></li>
    </ol>
</nav>

<div class="card mx-2" id="card_horarios">
    <div class="card-header bg-red-usat text-white" id="headingOne" data-bs-toggle="collapse"
        data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
        Generar Horarios Academicos
    </div>
    <div id="collapseOne" class="collapse show" aria-labelledby="headingOne" data-bs-parent="#miAccordion">
        <div class="card-body">
            <div class="my-3">
                <div id="estadoGeneracion">
                    <div class="d-flex align-items-center mb-2">
                        <div class="spinner-border spinner-border-sm text-success me-2" role="status" id="spinner1"></div>
                        <div id="estadoDisponibilidad">Disponibilidad de docentes</div>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <div class="spinner-border spinner-border-sm text-success me-2" role="status" id="spinner2" ></div>
                        <div>Cursos Activos</div>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <div class="spinner-border spinner-border-sm text-success me-2" role="status" id="spinner3"></div>
                        <div>Ambientes asignados</div>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <div class="spinner-border spinner-border-sm text-success me-2" role="status" id="spinner4"></div>
                        <div>Carga lectiva asignada</div>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <div class="spinner-border spinner-border-sm text-success me-2" role="status" id="spinner5"></div>
                        <div>Días laborables seleccionados</div>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <div class="spinner-border spinner-border-sm text-success me-2" role="status" id="spinner6"></div>
                        <div>Disponibilidades coinciden con las horas asignadas</div>
                    </div>
                </div>
            </div>
            <!-- Div superior -->
            <div class="row align-items-end my-3">
                <!-- Espacio y botones -->
                <div class="d-flex justify-content-center mt-3">
                    <button class="btn btn-success btn-lg mx-2" onclick="generarHorario()">Generar Horario</button>
                    <button class="btn btn-success btn-lg mx-2" onclick="RegistrarHorario()">Registrar Horario</button>
                    <button class="btn btn-danger btn-lg mx-2" onclick="limpiarTabla()">Limpiar</button>
                </div>
            </div>
            <!-- Progreso de generación de horario -->

            <!-- Tabla inferior -->
            <div class="card-body show">
                <div id="loading">
                    <div></div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-12" id="espacio_tabla">
                        <table class="table table-bordered text-center" id="tabla_horarios">
                            <thead class="border border-white bg-red-usat -horario-usat">
                                <tr>
                                    <th scope="col" class="border border-white text-light">Horas</th>
                                    <th scope="col" class="border border-white text-light">Lunes</th>
                                    <th scope="col" class="border border-white text-light">Martes</th>
                                    <th scope="col" class="border border-white text-light">Miércoles</th>
                                    <th scope="col" class="border border-white text-light">Jueves</th>
                                    <th scope="col" class="border border-white text-light">Viernes</th>
                                    <th scope="col" class="border border-white text-light">Sábado</th>
                                    <th scope="col" class="border border-white text-light">Domingo</th>
                                </tr>
                            </thead>
                            <tbody style="background-color: #EEEEEE;">
                                <!-- Las filas se llenarán dinámicamente con JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Carga -->
<div class="modal fade" id="loadingModal" tabindex="-1" aria-labelledby="loadingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="spinner-border text-success" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Generando Horario, por favor espere...</p>
            </div>
        </div>
    </div>
</div>


<style>
    #panel_docentes {
        display: flex;
        flex-wrap: wrap;
        margin-bottom: 20px;
    }

    .docente-tab {
        background-color: #4CAF50;
        color: white;
        padding: 10px 20px;
        margin: 5px;
        border-radius: 5px;
        cursor: pointer;
        display: inline-block;
    }

    .docente-tab.active {
        background-color: #3e8e41;
    }

    .docente-tab:hover {
        background-color: #45a049;
    }
</style>

<script>
    $(document).ready(function () {
        $('#tabla-cursos').DataTable({
            "paging": true,
            "pagingType": 'numbers',
            "info": false,
            "stateSave": true,
            language: {
                url: 'https://cdn.datatables.net/plug-ins/2.0.3/i18n/es-ES.json',
            },
        });

        verificarDisponibilidadDocentes();
    });

    var horario = [];
    var horarioJSON = '';

    function generarHorario() {
        $('#loadingModal').modal('show');
        $.ajax({
            url: '/generarHorario',
            type: 'GET',
            contentType: 'application/json',
            success: function (response) {
                horario = response;
                horarioJSON = horario;
                $('#loadingModal').modal('hide');
                llenarTablaHorarios(response);
            },
            error: function (xhr, status, error) {
                console.log(error);
                $('#loadingModal').modal('hide');
            }
        });
    }

    function verificarDisponibilidadDocentes() {
        $.ajax({
            url: '/get_docente_sin_disponibilidad',
            type: 'GET',
            contentType: 'application/json',
            success: function (response) {
                if (response.length > 0) {
                    console.log('response>0');
                    $('#spinner1').replaceWith('<i class="fa fa-exclamation-triangle text-danger me-2"></i>');
                    $('#estadoDisponibilidad').html('Hay Docentes sin disponibilidad Asignada <a href="/disponibilidad" class="btn btn-warning btn-sm ms-2">Resolver</a>');
                } else if (response.length == 0) {
                    console.log('response=0');
                    $('#spinner1').replaceWith('<i class="fa fa-check text-success me-2"></i>');
                    $('#estadoDisponibilidad').text('Disponibilidad de docentes');
                }
                console.log(response);
            },
            error: function (xhr, status, error) {
                console.log(error);
                $('#spinner1').replaceWith('<i class="fa fa-exclamation-triangle text-danger me-2"></i>');
                $('#estadoDisponibilidad').text('Error al verificar disponibilidad de docentes');
            }
        });
    }

    function llenarTablaHorarios(data) {
        const dias = ["Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado", "Domingo"];
        let horario = {};

        for (let dia of dias) {
            horario[dia] = {};
        }

        // Procesar los datos recibidos
        for (let curso in data) {
            for (let grupo in data[curso]) {
                for (let clase of data[curso][grupo]) {
                    let dia = clase.dia;
                    let hora_inicio = clase.hora_inicio;
                    let hora_fin = clase.hora_fin;
                    let aula = clase.aula;
                    let docente = clase.docente;
                    let detalle = `${curso}<br>${aula}<br>${docente}<br>${hora_inicio} - ${hora_fin}`;

                    let inicio = parseInt(hora_inicio.split(":")[0]);
                    let fin = parseInt(hora_fin.split(":")[0]);
                    for (let i = inicio; i < fin; i++) {
                        if (!horario[dia][i]) {
                            horario[dia][i] = [];
                        }
                        horario[dia][i].push({
                            detalle: detalle,
                            hora_inicio: hora_inicio,
                            hora_fin: hora_fin,
                            rowspan: fin - inicio
                        });
                    }
                }
            }
        }

        // Crear las filas de la tabla
        let tabla = $('#tabla_horarios tbody');
        tabla.empty();

        for (let i = 7; i <= 22; i++) {
            let fila = `<tr><th scope="row">${i}:00 - ${i + 1}:00</th>`;

            for (let dia of dias) {
                if (horario[dia][i] && horario[dia][i].length > 0) {
                    let clase = horario[dia][i][0];
                    if (clase.rowspan) {
                        fila += `<td class="bg-warning text-center" style="vertical-align:middle;" rowspan="${clase.rowspan}">${clase.detalle}</td>`;
                        // Remover rowspan para que no se repita en filas subsecuentes
                        for (let j = 1; j < clase.rowspan; j++) {
                            if (horario[dia][i + j]) {
                                horario[dia][i + j] = horario[dia][i + j].filter(c => c.detalle !== clase.detalle);
                            }
                        }
                    } else {
                        fila += `<td class="bg-warning text-center" style="vertical-align:middle;">${clase.detalle}</td>`;
                    }
                } else {
                    fila += `<td class="bg-warning text-center" style="vertical-align:middle;"></td>`;
                }
            }

            fila += `</tr>`;
            tabla.append(fila);
        }
    }

    function RegistrarHorario() {
        $.ajax({
            url: '/insertar_horarios_ia',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ horarios: horarioJSON }),
            success: function (response) {
                console.log('Horario registrado exitosamente:', response);
            },
            error: function (xhr, status, error) {
                console.log('Error al registrar el horario:', error);
            }
        });
    }

    function limpiarTabla() {
        let tabla = $('#tabla_horarios tbody');
        tabla.empty();
    }
</script>

{% endblock %}
