{% extends "dashboard/index.html" %}

{% block titulo %} Curso por Ambientes {% endblock %}

{% block contenido %}

<nav style="--bs-breadcrumb-divider: '>'" aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Inicio</a></li>
        <li class="breadcrumb-item active"><a href="{{ url_for('ambientesxCursos') }}">Asignar Ambientes por Cursos</a></li>
    </ol>
</nav>
<div class="container-fluid my-4">
    <div class="card w-500" id="card_cursos">
        <div class="card-header bg-red-usat text-white" id="headingOne" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
            Ambientes por curso
        </div>
        <div class="ms-4 mt-3">
            <!-- Semestre -->
            <div class="d-flex mb-3 mt-3">
                <label for="" class="mb-2 mt-2" style="width: 8%;">Semestre:</label>
                <select class="form-select" aria-label="Default select example" id="semestre">
                    <option selected disabled>-----Seleccione un semestre-----</option>
                    {% for semestre in semestres %}
                    <option>{{ semestre[0] }}</option>
                    {% endfor %}
                </select>
            </div>
            <!-- Escuelas -->
            <div class="d-flex mb-3 me-4 mt-3">
                <label for="" class="mb-2 mt-2" style="width: 8%;">Escuela:</label>
                <select class="form-select" aria-label="Default select example" id="escuela">
                    <option selected disabled>-----Seleccione una escuela-----</option>
                    {% for escuela in escuelas %}
                    <option>{{ escuela[0] }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <hr class="border-black" style="margin-bottom: 0%;">
        <div class="card-body">
            <div class="table-responsive" id="miTabla">
                <table class="table table-striped table-bordered tabla-cursos" style="width:100%" id="tabla-cursos">
                    <thead>
                        <tr>
                            <th style="text-align:center">Ciclo</th>
                            <th style="text-align:center">Nombre del Curso</th>
                            <th style="text-align:center">Ambiente(s)</th>
                            <th style="text-align:center">Opciones</th>
                        </tr>
                    </thead>
                    <tbody id="cuerpo_tabla">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal para la asignación de ambientes -->
<div class="modal fade" id="modalAsignacion" tabindex="-1" aria-labelledby="modalAsignacionLabel" aria-hidden="true">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalAsignacionLabel">Asignar ambiente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formAsignacionAmbiente">
                    <div class="mb-3">
                        <label for="buscarAmbiente" class="form-label">Buscar ambiente:</label>
                        <input type="text" class="form-control" id="buscarAmbiente" placeholder="Escriba para buscar...">
                        <ul id="sugerenciasAmbiente" class="list-group" style="position: absolute; z-index: 1000;"></ul>
                    </div>
                    <div class="mb-3">
                        <label for="ambientesSeleccionados" class="form-label">Seleccionados:</label>
                        <div id="ambientesSeleccionados" class="form-control" style="height: auto;">
                            <!-- Los ambientes seleccionados se mostrarán aquí -->
                        </div>
                    </div>
                    <input type="hidden" id="cursoIdSeleccionado" name="cursoIdSeleccionado">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="guardarAsignacion">Guardar</button>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function () {
        var ambientesSeleccionados = [];
        var listaAmbientes = [];
        var ambientesEliminados = [];

        $.ajax({
            url: '/obtener_ambientes_activos',
            type: 'GET',
            contentType: 'application/json',
            success: function (response) {
                listaAmbientes = response;
            },
            error: function (xhr, status, error) {
                console.log('Error al obtener la lista de ambientes:', error);
            }
        });

        $('#buscarAmbiente').on('input', function () {
            var query = $(this).val().toLowerCase();
            var sugerencias = listaAmbientes.filter(function (ambiente) {
                return ambiente.nombre.toLowerCase().includes(query);
            });
            mostrarSugerencias(sugerencias);
        });

        function mostrarSugerencias(sugerencias) {
            var contenedorSugerencias = $('#sugerenciasAmbiente');
            contenedorSugerencias.empty();
            sugerencias.forEach(function (ambiente) {
                contenedorSugerencias.append(`<li class="list-group-item list-group-item-action" data-id="${ambiente.idambiente}">${ambiente.nombre}</li>`);
            });
        }

        $('#sugerenciasAmbiente').on('click', 'li', function () {
            var id = $(this).data('id');
            var nombre = $(this).text();
            if (!ambientesSeleccionados.find(amb => amb.id === id)) {
                ambientesSeleccionados.push({ id: id, nombre: nombre });
                actualizarAmbientesSeleccionados();
            }
            $('#buscarAmbiente').val('');
            $('#sugerenciasAmbiente').empty();
        });

        function actualizarAmbientesSeleccionados() {
            var container = $('#ambientesSeleccionados');
            container.empty();
            if (ambientesSeleccionados.length === 0) {
                container.append('<p class="placeholder-text">No tiene ambiente asignado</p>');
            } else {
                ambientesSeleccionados.forEach(function (amb) {
                    container.append(`
                        <div class="ambiente-tag">
                            ${amb.nombre}
                            <span class="remove-tag" data-id="${amb.id}">&times;</span>
                        </div>
                    `);
                });
            }
        }

        $('#ambientesSeleccionados').on('click', '.remove-tag', function () {
            var id = $(this).data('id');
            var nombre = $(this).parent().text().slice(0, -1);
            ambientesSeleccionados = ambientesSeleccionados.filter(function (amb) {
                return amb.id !== id;
            });
            ambientesEliminados.push({ id: id, nombre: nombre });
            actualizarAmbientesSeleccionados();
        });

        $('#guardarAsignacion').on('click', function () {
            var cursoId = $('#cursoIdSeleccionado').val();
            var ambientes = ambientesSeleccionados.map(amb => amb.id);

            $.ajax({
                url: '/asignar_ambientes',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ idcurso: cursoId, idambientes: ambientes, eliminados: ambientesEliminados.map(amb => amb.id) }),
                success: function (response) {
                    $('#modalAsignacion').modal('hide');
                    rellenarTablaCursos($('#escuela').val(), $('#semestre').val());
                    ambientesEliminados = [];  
                },
                error: function (xhr, status, error) {
                    console.error('Error al asignar ambientes:', error);
                }
            });
        });

        $('#tabla-cursos tbody').on('click', '.btnAsignar', function () {
            var cursoId = $(this).data('id');
            var cursoNombre = $(this).data('curso');
            $('#modalAsignacionLabel').text(`Asignar ambiente para ${cursoNombre}`);
            $('#cursoIdSeleccionado').val(cursoId);
            cargarAmbientesAsignados(cursoId);
            $('#modalAsignacion').modal('show');
        });

        function cargarAmbientesAsignados(cursoId) {
            $.ajax({
                url: `/obtenerAmbientesCurso/${cursoId}`,
                type: 'GET',
                success: function (response) {
                    ambientesSeleccionados = response.map(amb => ({ id: amb.idambiente, nombre: amb.nombre }));
                    actualizarAmbientesSeleccionados();
                },
                error: function (xhr, status, error) {
                    console.error('Error al cargar los ambientes asignados:', error);
                }
            });
        }

        $('#modalAsignacion').on('show.bs.modal', function (event) {
            $('#buscarAmbiente').val('');
            $('#sugerenciasAmbiente').empty();
        });

        var table = $('#tabla-cursos').DataTable({
            paging: false,
            info: false,
            autoWidth: true,
            responsive: true,
            scroller: true,
            scrollY: '200px',
            searching: true,
            processing: true,
            serverSide: false,
            dom: 'Bfrtip',
            buttons: [
                {
                    extend: 'collection',
                    text: '<i class="fas fa-file-import"></i> Importar',
                    className: 'btn btn-secondary',
                    buttons: [
                        {
                            text: '<i class="fas fa-upload"></i> Subir Archivo',
                            className: 'dropdown-item',
                            action: function (e) {
                                e.preventDefault();
                                $('#modalSubidaMasiva').modal('show');
                            }
                        },
                        {
                            text: '<i class="fas fa-download"></i> Descargar Plantilla',
                            className: 'dropdown-item',
                            action: function (e) {
                                e.preventDefault();
                                descargarPlantilla();
                            }
                        },
                    ]
                },
                {
                    extend: 'collection',
                    text: '<i class="fas fa-file-export"></i> Exportar/Imprimir',
                    className: 'btn btn-secondary',
                    buttons: [
                        {
                            extend: 'copy',
                            text: '<i class="fas fa-copy"></i> Copiar',
                            className: 'dropdown-item'
                        },
                        {
                            extend: 'csv',
                            text: '<i class="fas fa-file-csv"></i> CSV',
                            className: 'dropdown-item'
                        },
                        {
                            extend: 'excel',
                            text: '<i class="fas fa-file-excel"></i> Excel',
                            className: 'dropdown-item'
                        },
                        {
                            extend: 'pdf',
                            text: '<i class="fas fa-file-pdf"></i> PDF',
                            className: 'dropdown-item'
                        },
                        {
                            extend: 'print',
                            text: '<i class="fas fa-print"></i> Imprimir',
                            className: 'dropdown-item'
                        }
                    ]
                },
            ],
            columns: [
                { data: "ciclo", className: "text-center id" },
                { data: "cursos" },
                {
                    data: "ambientes",
                    className: "text-center",
                    render: function (data, type, row) {
                        return `<textarea class="form-control" rows="3">${data}</textarea>`;
                    }
                },
                {
                    data: null,
                    render: function (data, type, row) {
                        return `
                            <button class="btn btn-warning btn-sm btnAsignar" data-id="${row.idcurso}" data-curso="${row.cursos}" title="Asignar"><i class="fas fa-pencil-alt"></i></button>
                            <button class="btn btn-danger btn-sm btnEliminar" data-id="${row.idcurso}" data-nombre="${row.cursos}" title="Eliminar"><i class="fas fa-times"></i></button>
                        `;
                    },
                    className: "text-center",
                }
            ],
            language: {
                url: "https://cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json"
            }
        });

        function rellenarTablaCursos(escuela, semestre) {
            fetch(`/tabla_curso_ambiente/${escuela}/${semestre}`)
                .then(response => response.json())
                .then(data => {
                    table.clear();
                    table.rows.add(data);
                    table.draw();
                })
                .catch(error => {
                    console.error('Error al obtener los datos de la tabla de cursos:', error);
                });
        }

        $('#escuela, #semestre').on('change', function () {
            const escuela = $('#escuela').val();
            const semestre = $('#semestre').val();
            if (escuela && semestre) {
                rellenarTablaCursos(escuela, semestre);
            }
        });

    });
</script>

{% endblock %}
